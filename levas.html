<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gráfico Polar - Manual de Levas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffffff;
      color: #e5e5e5;
      padding: 30px;
    }
    h2 {
      text-align: center;
      color: #0a0909;
    }
    .titulo-seccion {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      border-bottom: 2px solid #00bfff;
      padding-bottom: 5px;
      color: #ffffff;
    }
    .grupo-control {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .grupo {
      display: flex;
      flex-direction: column;
      width: 180px;
    }
    label {
      font-weight: 600;
      margin-bottom: 4px;
      color: #c9d1d9;
    }
    input {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #3a3f5c;
      background: #60b0e6;
      color: #070606;
      font-weight: bold;
      text-align: center;
    }
    input:focus {
      outline: none;
      border-color: #00bfff;
      box-shadow: 0 0 4px #00bfff;
    }
    button {
      background: #00bfff;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0095cc;
    }
    input.input-error {
      border: 2px solid #ff5e57;
      background-color: #3a1e1e;
      animation: blink 0.5s step-end infinite alternate;
    }
    @keyframes blink {
      0% { box-shadow: 0 0 0 #ff5e57; }
      100% { box-shadow: 0 0 6px 2px #ff5e57; }
    }
    #descripcion {
      background: #263248;
      border-left: 5px solid #00bfff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 6px;
      font-size: 14px;
      color: #d6eaff;
    }
    .seccion,
    canvas {
      max-width: 1000px;
      margin: 30px auto;
      background: #222022;
      border-radius: 12px;
      margin-bottom: 30px;
      padding: 20px;
      width: 90%;
    }
    .seccion:hover {
      background-color: #1d1f25;
      box-shadow: 0 0 15px 2px #282929;
      transition: all 0.3s ease;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    @media (max-width: 768px) {
      .grupo-control { flex-direction: column; gap: 10px; }
      .grupo { width: 100%; }
      button { width: 100%; margin-bottom: 10px; }
    }
    #leyenda {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
      padding-top: 10px;
    }
    #leyenda .item-leyenda {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: bold;
      color: #ffffff;
    }
    #leyenda .color-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Trayectos Circulares de Levas</h2>

    <div class="seccion">
      <div class="titulo-seccion">Sistema de Mordazas Horizontal</div>
      <div class="grupo-control" id="mordazasHorizontal"></div>
    </div>

    <div class="seccion">
      <div class="titulo-seccion">Sistema de Mordazas Vertical</div>
      <div class="grupo-control" id="mordazasVertical"></div>
    </div>

    <div class="seccion">
      <div class="titulo-seccion">Otros Sistemas</div>
      <div class="grupo-control" id="otros"></div>
    </div>

    <div class="seccion">
      <div class="titulo-seccion">Leyenda del Gráfico</div>
      <div id="leyenda" class="grupo-control"></div>
    </div>

    <div class="seccion">
      <canvas id="canvas" width="500" height="600"></canvas>
      <button onclick="dibujar()">Actualizar Gráfico</button>
      <button onclick="sugerirParametros()">Sugerir Parámetros</button>
    </div>

    <div id="descripcion"></div>
  </div>

  <script>
    const levas = [
      'Mordaza Frontal', 'Mordaza Posterior', 'Impulso H Inferior',
      'Impulso H Superior', 'Sello', 'Impulso Vertical',
      'Arrastre', 'Fotocelda', 'Dosificación'
    ];

    const colores = [
      '#FF6384', '#36A2EB', '#4BC0C0', '#00C853',
      '#F87400', '#8E24AA', '#9966FF', '#FFCE56', '#007bff'
    ];

    let valoresIniciales = [
      [280, 300], [260, 305], [200, 240], [210, 250],
      [270, 320], [130, 170], [330, 50], [60, 300], [230, 290]
    ];

    function toRadians(deg) {
      return (deg - 90) * Math.PI / 180;
    }

    function validarRango(input) {
      const valor = parseInt(input.value);
      if (isNaN(valor) || valor < 0 || valor > 359) {
        input.classList.add("input-error");
      } else {
        input.classList.remove("input-error");
      }
    }

    function generarEntradas() {
      const grupos = {
        'Mordaza Frontal': 'mordazasHorizontal',
        'Mordaza Posterior': 'mordazasHorizontal',
        'Impulso H Inferior': 'mordazasHorizontal',
        'Impulso H Superior': 'mordazasHorizontal',
        'Sello': 'mordazasVertical',
        'Impulso Vertical': 'mordazasVertical'
      };

      levas.forEach((nombre, i) => {
        const grupoDiv = document.createElement('div');
        grupoDiv.className = 'grupo';
        grupoDiv.innerHTML = `
          <label>${nombre}</label>
          Inicio: <input type="number" id="inicio${i}" value="${valoresIniciales[i][0]}" min="0" max="359" oninput="validarRango(this)">
          Fin: <input type="number" id="fin${i}" value="${valoresIniciales[i][1]}" min="0" max="359" oninput="validarRango(this)">
        `;
        const contenedor = document.getElementById(grupos[nombre] || 'otros');
        contenedor.appendChild(grupoDiv);
      });
    }

    function dibujar() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const cx = canvas.width / 2;
      const cy = canvas.height / 2;
      const radioBase = 100;
      const valores = [];
      let hayErrores = false;
      document.getElementById('descripcion').innerHTML = "";

      for (let i = 0; i < levas.length; i++) {
        const inicio = parseInt(document.getElementById(inicio${i}).value);
        const fin = parseInt(document.getElementById(fin${i}).value);
        if (isNaN(inicio) || isNaN(fin) || inicio < 0 || inicio > 359 || fin < 0 || fin > 359) {
          hayErrores = true;
          validarRango(document.getElementById(inicio${i}));
          validarRango(document.getElementById(fin${i}));
        }
        valores.push([inicio, fin]);
      }

      if (hayErrores) {
        alert("Hay valores fuera de rango (0–359). Corrígelos antes de continuar.");
        return;
      }

      const [mf, mp, , , sello, , arrastre, , dosif] = valores;
      const conflictos = [];

      if (conflicto(arrastre, mf) || conflicto(arrastre, mp) || conflicto(arrastre, sello))
        conflictos.push("❌ Arrastre no puede estar activo con Mordaza Frontal, Posterior o Sello.");
      if (!(contenidoEn(dosif, mf) && contenidoEn(dosif, mp)))
        conflictos.push("❌ Dosificación debe estar contenida dentro de ambas mordazas.");
      if (conflicto(dosif, sello))
        conflictos.push("❌ Dosificación se solapa con el ciclo de Sello.");

      const descripcion = document.getElementById('descripcion');
      descripcion.innerHTML = conflictos.length
        ? <b>Conflictos detectados:</b><ul><li>${conflictos.join('</li><li>')}</li></ul>
        : <b>✅ Sin conflictos. Configuración válida.</b>;

      for (let i = 0; i < levas.length; i++) {
        const [inicio, fin] = valores[i];
        const radio = radioBase + i * 15;
        if (fin < inicio) {
          dibujarArco(ctx, cx, cy, radio, inicio, 360, colores[i]);
          dibujarArco(ctx, cx, cy, radio, 0, fin, colores[i]);
        } else {
          dibujarArco(ctx, cx, cy, radio, inicio, fin, colores[i]);
        }

        const anguloTexto = ((inicio + ((fin - inicio + 360) % 360) / 2) % 360);
        const rad = toRadians(anguloTexto);
        const x = cx + (radio + 10) * Math.cos(rad);
        const y = cy + (radio + 10) * Math.sin(rad);
        const texto = ${inicio}°–${fin}°;

        ctx.font = "bold 11px Poppins";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        const anchoTexto = ctx.measureText(texto).width;
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        ctx.fillRect(x - anchoTexto / 2 - 4, y - 8, anchoTexto + 8, 16);
        ctx.fillStyle = "#000000";
        ctx.fillText(texto, x, y);
      }

      const leyenda = document.getElementById("leyenda");
      leyenda.innerHTML = "";
      levas.forEach((nombre, i) => {
        const div = document.createElement("div");
        div.className = "item-leyenda";
        div.innerHTML = <span class="color-box" style="background:${colores[i]}"></span>${nombre};
        leyenda.appendChild(div);
      });
    }

    function dibujarArco(ctx, cx, cy, radio, angInicio, angFin, color) {
      ctx.beginPath();
      ctx.arc(cx, cy, radio, toRadians(angInicio), toRadians(angFin));
      ctx.strokeStyle = color;
      ctx.lineWidth = 5;
      ctx.stroke();
    }

    function conflicto(a, b) {
      const expand = ([i, f]) => (f >= i ? [[i, f]] : [[i, 359], [0, f]]);
      return expand(a).some(([ai, af]) =>
        expand(b).some(([bi, bf]) => ai < bf && af > bi));
    }

    function contenidoEn(a, b) {
      return (a[0] >= b[0] && a[1] <= b[1]) ||
             (b[0] > b[1] && (a[0] >= b[0] || a[1] <= b[1]));
    }

    function sugerirParametros() {
      const sugeridos = [
        [280, 300], [260, 305], [200, 240], [210, 250],
        [310, 350], [130, 170], [160, 350], [60, 280], [270, 300]
      ];

      const [mf, mp, , , sello, , arrastre, , dosif] = sugeridos;

      if (conflicto(arrastre, mf) || conflicto(arrastre, mp) || conflicto(arrastre, sello)) {
        sugeridos[6] = [0, mf[0] - 5];
      }

      const interseccion = [Math.max(mf[0], mp[0]), Math.min(mf[1], mp[1])];
      if (dosif[0] < interseccion[0] || dosif[1] > interseccion[1] || conflicto(dosif, sello)) {
        sugeridos[8] = [interseccion[0], Math.min(interseccion[1], sello[0] - 5)];
      }

      sugeridos.forEach(([ini, fin], i) => {
        document.getElementById(inicio${i}).value = ini;
        document.getElementById(fin${i}).value = fin;
        validarRango(document.getElementById(inicio${i}));
        validarRango(document.getElementById(fin${i}));
      });

      dibujar();
    }

    generarEntradas();
    dibujar();
  </script>
</body>
</html>
